---
title: "REU-Project-Results"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown
```{r}
library(here)
library(tidyverse)
library(car)
library(lme4)
library(piecewiseSEM)
library(broom)
library(performance)
library(broom.mixed)
library(sjPlot)
dist_10m <- read_rds(here("data","10m_resolution_1ha_dists.rds"))
dist_fine <- read_rds(here("data","full_1ha_location_data.rds"))
CF_data <- read_csv(here("data","ha_clean.csv"))

CF_data <- CF_data %>% 
  filter(habitat == "CF")

```


## Background Information



## Questions asked 
Are there edge-dependent effects impacting survival, flowering, and size of 
H. acuminata within 1-ha forest fragments in the BDFFP?

## Methods 





## Preliminary Results

Is there a edge effect on survival in H. acuminata? 

I looked at distance as a
predictor for survival using center point of the 10x10 sub plots. I started by 
first determining if year was a significant random effect for survival by using 
likelihood ratio test. I found that year was not a significant random effect and 
distance to nearest edge was also not a significant predictor of survival.


```{r}
dist_10m_surv <- dist_10m %>%
  filter(!is.na(size_prev) & !is.na(surv)) 

dist_10m$year <- as.factor(dist_10m$year)
dist_10m$bdffp_reserve_no <- as.factor(dist_10m$bdffp_reserve_no)
dist_10m$surv <- as.factor(dist_10m$surv)
dist_10m$flwr <- as.factor(dist_10m$flwr)
dist_10m$flwr_prev <- as.factor(dist_10m$flwr_prev)


surv.m1 <- glmer(surv~log_size_prev+dist_near+bdffp_reserve_no+(1|year),
                  data=dist_10m,family=binomial)

surv.m2 <- glm(surv~log_size_prev+dist_near+bdffp_reserve_no,data=dist_10m,family=binomial)

anova(surv.m1,surv.m2, test="LRT")

surv.m3 <- glm(surv~log_size_prev+bdffp_reserve_no,data=dist_10m,family=binomial)

anova(surv.m3,surv.m2, test="LRT")

performance::r2(surv.m3)
check_model(surv.m3)
```

I repeated this analysis using a separate data frame containing distances to edge that
were accurate to roughly 0.1m. At a finer scale, distance was a significant predictor 
for survival (p = 0.007) and year was a significant random effect, using LRTs to compare a mixed effect model to a normal generalized linear model.. 

```{r}
dist_fine$year <- as.factor(dist_fine$year)
dist_fine$bdffp_reserve_no <- as.factor(dist_fine$bdffp_reserve_no)
dist_fine$flwr <- as.factor(dist_fine$flwr)
dist_fine$flwr_prev <- as.factor(dist_fine$flwr_prev)
dist_fine$surv <- as.factor(dist_fine$surv)


surv.fine.m1 <- glmer(surv~log_size_prev+distance_to_nearest_edge+bdffp_reserve_no+(1|year),
                   data=dist_fine,family=binomial)


surv.fine.m2 <- glm(surv~log_size_prev+distance_to_nearest_edge+bdffp_reserve_no,
                  data=dist_fine,family=binomial)

anova(surv.fine.m1,surv.fine.m2)

surv.fine.m3 <- glmer(surv~log_size_prev+bdffp_reserve_no+(1|year),
                      data=dist_fine,family=binomial)

anova(surv.fine.m1,surv.fine.m3,test="LRT")

performance::r2(surv.fine.m1)
performance::check_model(surv.fine.m1)

# test possible combinations of interactions 

surv.fine.m4 <- glmer(surv~log_size_prev*bdffp_reserve_no*distance_to_nearest_edge+(1|year),
                      data=dist_fine,family=binomial)
anova(surv.fine.m4,surv.fine.m1, test="LRT")

check_outliers(surv.fine.m1)
check_collinearity(surv.fine.m1)

```

Since I detected an edge effect for survival, what is its depth of influence (DOI)? The figure below shows that for the average sized H. acuminata, plots 2107 and 3114 survival rates were much higher than CF habitat, while plot 1104 had comparable survival probabilities with CF 9m away from the nearest edge, thereafter the plot outperformed CF survival probability. I'm curious why CF has a lower calculated survival probability compared to these fragments. One explanation is that CF may have more old plants on average than forest fragment plots, which could explain the discrepancy in the predicted vital rates. Either that or the functional form of the model is overestimating survival in forest fragments.
```{r}
CF.surv <- glm(surv~1,data=CF_data,family=binomial)
CF.CI <-confint(CF.surv, level=0.84)
CF.CI.bt <- plogis(CF.CI)

CF.surv.df <- broom::augment(CF.surv,
                               se_fit=TRUE,
                               type.predict="response")

base.surv <- CF.surv.df$.fitted[1]
# Eric's contribution helping me smooth out the curves.. 

newdata = data.frame(log_size_prev = mean(dist_fine$log_size_prev, na.rm = TRUE),
                     distance_to_nearest_edge = seq(0, 50, by = 0.1),
                     bdffp_reserve_no = unique(dist_fine$bdffp_reserve_no))

nwdat.df <-broom::augment(surv.fine.m2, type.predict = "response", newdata = newdata,
                          se_fit=TRUE)
  ggplot(data=nwdat.df,aes(x = distance_to_nearest_edge)) + 
  geom_line(aes(y=.fitted,color=bdffp_reserve_no))+
  geom_ribbon(aes(ymin=.fitted-1.405*.se.fit,ymax=.fitted+1.405*.se.fit),fill="gray",alpha=0.5)+
geom_hline(aes(yintercept=base.surv,color="CF"))+
  geom_ribbon(aes(ymin=base.surv-1.405*CF.surv.df$.se.fit[1],ymax=base.surv+1.405*CF.surv.df$.se.fit[1]),
              fill="red",alpha=0.5)

```

I'm particularly curious about the aforementioned plots 2107 and 3114, which show remarkably high survival probabilities and yet my data visualization of the population decline in forest fragments over the years seems to contradict these predicted survival probabilities. Below is a figure showing total population over time and population broken down by bdffp_reserve_no.

```{r}
pop_num <- dist_10m %>%
  group_by(year) %>%
  summarize(n=n())


ggplot(data=pop_num,aes(x=year))+
  geom_point(aes(y=n))



```
```{r}
pop_num2 <- dist_10m %>%
  group_by(bdffp_reserve_no,year) %>%
  summarize(n=n())

ggplot(data=pop_num2)+
  geom_point(aes(x=year,y=n,color=bdffp_reserve_no))
```

Since plants regress in size prior to dying, the actual interesting values to analyze here are not survival probabilities of average sized plants, but rather the survival probabilities of smaller plants, which largely constitute the decline observed in the population growth figures. Survival probabilities adjusted in plot 3114, suggesting that plot is particularly sensitive to perturbation of log_size_prev compared to the other forest fragments. Plot 3114 and CF survival probabilities were indistinguishable 20m away from the nearest edge, after which the forest fragment survival probabilities were higher than CF.

```{r}
quantile(dist_fine$log_size_prev,na.rm=TRUE)

newdata2 <- data.frame((log_size_prev =quantile(dist_fine$log_size_prev,na.rm=TRUE)[2]),
                       distance_to_nearest_edge=seq(0,50,by=0.1),
                       bdffp_reserve_no = unique(dist_fine$bdffp_reserve_no))

colnames(newdata2)[1] <- "log_size_prev"

nwdat2.df <-broom::augment(surv.fine.m2, type.predict = "response", newdata = newdata2,
                          se_fit=TRUE)

CF.nwdat <- data.frame(log_size_prev=quantile(CF_data$log_size_prev,na.rm=TRUE)[2])

CF.nwdat.surv <- broom::augment(CF.surv,newdata=CF.nwdat,
                                se_fit=TRUE,
                                type.predict="response")



  ggplot(data=nwdat2.df,aes(x = distance_to_nearest_edge)) + 
  geom_line(aes(y=.fitted,color=bdffp_reserve_no))+
  geom_ribbon(aes(ymin=.fitted-1.405*.se.fit,ymax=.fitted+1.405*.se.fit),fill="gray",alpha=0.5)+
geom_hline(aes(yintercept=CF.nwdat.surv$.fitted,color="CF"))+
  geom_ribbon(aes(ymin=CF.nwdat.surv$.fitted-1.405*CF.nwdat.surv$.se.fit,
                  ymax=CF.nwdat.surv$.fitted+1.405*CF.nwdat.surv$.se.fit),
              fill="red",alpha=0.5)




```

Comparison of quantiles in log_size_prev in two habitat types: (1) FF (2) CF

```{r}
quantile(dist_fine$log_size_prev,na.rm=TRUE)
quantile(CF_data$log_size_prev,na.rm=TRUE)
```


II. Is there an edge effect on flowering probability in H. acuminata?

Found that year is a relevant random effect, though df comparison may be questionable, as there is debate
on how random effects should contribute to degrees of freedom, also based on hierarchy of experimental design. There was a significant interaction term log_size_prev*bdffp_reserve_no and 
distance_near was not a significant predictor of flowering for 10m data set. Model diagnostics show major collinearity 
issues, which may make assessing the value of individual predictors very difficult, so these results, as they currently are, should be interpreted cautiously. 

```{r}
flwr.m1 <- glmer(flwr~log_size_prev+flwr_prev+dist_near+bdffp_reserve_no+(1|year),
                  data=dist_10m,family=binomial)

flwr.m2 <- glm(flwr~log_size_prev+dist_near+bdffp_reserve_no,
               data=dist_10m,family=binomial)

anova(flwr.m1,flwr.m2, test="LRT")


# interaction terms are significant time to figure them out 

flwr.m3 <- glmer(flwr~log_size_prev*dist_near*bdffp_reserve_no+flwr_prev+(1|year),
                 data=dist_10m,family=binomial)

anova(flwr.m1,flwr.m3,test="LRT")
car::Anova(flwr.m3)

flwr.m4 <- glmer(flwr~log_size_prev*bdffp_reserve_no+dist_near+flwr_prev+(1|year),
                 data=dist_10m,family=binomial)
flwr.m5 <- glmer(flwr~log_size_prev*bdffp_reserve_no+flwr_prev+(1|year),
                 data=dist_10m,family=binomial)
flwr.m6 <- glmer(flwr~log_size_prev*bdffp_reserve_no+(1|year),data=dist_10m,
                 family=binomial)

flwr.m7 <- glmer(flwr~log_size_prev+bdffp_reserve_no+flwr_prev+(1|year),data=dist_10m,
                 family=binomial)



anova(flwr.m4,flwr.m3,test="LRT")
anova(flwr.m5,flwr.m4,test="LRT")
anova(flwr.m6,flwr.m5,test="LRT")
anova(flwr.m7,flwr.m5,test="LRT")


check_model(flwr.m7)

# final model is flwr.m5, but there are issues with collinearity, not sure how to address it.


```

Now to repeat this analysis using finer distances. We found that year was a significant random effect and distance to nearest edge was also a significant predictor(Ï‡2 = 4.1382, df=1, p= 0.041) for flowering probability.  

```{r}
flwr.fine.m1 <- glmer(flwr~log_size_prev+flwr_prev+distance_to_nearest_edge+bdffp_reserve_no+(1|year),
                  data=dist_fine,family=binomial)

flwr.fine.m2 <- glm(flwr~log_size_prev+flwr_prev+distance_to_nearest_edge+bdffp_reserve_no,
                    data=dist_fine,family=binomial)

flwr.fine.m3 <- glmer(flwr~log_size_prev+flwr_prev+bdffp_reserve_no+(1|year),
                      data=dist_fine,family=binomial)

flwr.fine.m4 <- glmer(flwr~log_size_prev+flwr_prev+distance_to_nearest_edge+(1|year),
                      data=dist_fine,family=binomial)

flwr.fine.m5 <- glmer(flwr~log_size_prev+distance_to_nearest_edge+bdffp_reserve_no+(1|year),
                      data=dist_fine,family=binomial)

#final model is first model
anova(flwr.fine.m1,flwr.fine.m2,test="LRT")
anova(flwr.fine.m3,flwr.fine.m1,test="LRT")
anova(flwr.fine.m4,flwr.fine.m1,test="LRT")
anova(flwr.fine.m5,flwr.fine.m1,test="LRT")

performance::check_model(flwr.fine.m1)
sjPlot::tab_model(flwr.fine.m1)
```

What is the DOI of the effect? 

```{r}

flwr.fine.DOI <- glm(flwr~log_size_prev+flwr_prev+distance_to_nearest_edge+bdffp_reserve_no,
                  data=dist_fine,family=binomial)


CF.flwr<- glm(flwr~1, data=CF_data,family=binomial)
CF.flwr.nwdat <- data.frame(log_size_prev = quantile(CF_data$log_size_prev,na.rm=TRUE)[4])
colnames(CF.flwr.nwdat)[1] <- "log_size_prev"
CF.flwr.df <- broom::augment(CF.flwr,se_fit=TRUE,newdata=CF.flwr.nwdat,type.predict="response")

dist_fine_noNA<-dist_fine %>%
  filter(!is.na(flwr_prev)) 






newdata.flwr <- data.frame(log_size_prev=quantile(dist_fine$log_size_prev,na.rm=TRUE)[4],
                           distance_to_nearest_edge = seq(0,50,by=0.1),
                           bdffp_reserve_no = unique(dist_fine$bdffp_reserve_no))


flwr.factor <-data.frame(flwr_prev=rep(c(0,1),251))
flwr.factor <- flwr.factor[-502,]

newdata.test <- rbind(newdata.flwr,flwr.factor)

pred.flwr <- broom::augment(flwr.fine.DOI,newdata=newdata.flwr,se_fit=TRUE,type.predict="response")

ggplot(data=pred.flwr,aes(x = distance_to_nearest_edge)) + 
  geom_line(aes(y=.fitted,color=bdffp_reserve_no))+
  geom_ribbon(aes(ymin=.fitted-1.405*.se.fit,ymax=.fitted+1.405*.se.fit),fill="gray",alpha=0.5)+
geom_hline(aes(yintercept=CF.flwr.df$.fitted,color="CF"))+
  geom_ribbon(aes(ymin=CF.flwr.df$.fitted-1.405*CF.flwr.df$.se.fit,
                  ymax=CF.flwr.df$.fitted+1.405*CF.flwr.df$.se.fit),
              fill="red",alpha=0.5)



```





III. Is there an edge effect on log_size of H. acuminata?





